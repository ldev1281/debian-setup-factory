#!/bin/bash

@module logger.bash

REQUIRED_TOOLS="docker git bws"

# === Helpers ===
print_authentik_next_steps() {
  cat <<'EOF'

============================================================
Authentik has been successfully installed.
Before proceeding with the installation of other applications, you must configure
application authorization and single sign-on (SSO) in Authentik.

This includes:
- Creating providers and applications in the Authentik admin panel.
- Setting up authentication flows (login, signup, etc.).
- Generating client credentials (client ID/secret) for the apps you plan to integrate.

⚠️ Important: Do not continue with further application setups until Authentik is
properly configured to handle authentication, otherwise logins will not work.
============================================================

EOF
}

# === Check for required tools  ===

missed_tools=()
for cmd in $REQUIRED_TOOLS; do
    if ! command -v "$cmd" >/dev/null 2>&1; then
        missed_tools+=("$cmd")
    fi
done

if ((${#missed_tools[@]})); then
    echo "Required tools not found:" >&2
    for cmd in "${missed_tools[@]}"; do
        echo "  - $cmd" >&2
    done
    echo "Hint: run dev-prod-init.recipe from debian-setup-factory" >&2
    echo "Abort"
    exit 127
fi

# Include other modules only after checking for required tools
@module bitwarden.bash

MODULES_APPS="${MODULES_APPS:-proxy-client-setup.bash authentik-setup.bash outline-setup.bash}"

for module_app in $MODULES_APPS; do
  echo
  echo "$module_app"
  read -r -p "Install $module_app? [y/N]: " a
  [[ "${a,,}" =~ ^(y|yes)$ ]] || { logger::warn "$module_app: skipped"; continue; }

  case "$module_app" in
    proxy-client-setup.bash)
      export PROXY_HOST="$(bitwarden::get_secret 'proxy-hostname' "$BWS_PROJECT_ID")"
      export PROXY_SOCKS5H_PORT="$(bitwarden::get_secret 'proxy-socks5h-port' "$BWS_PROJECT_ID")"
      export PROXY_CLIENT_CADDY_AUTHENTIK_APP_HOSTNAME="$(bitwarden::get_secret 'app-authentik-hostname' "$BWS_PROJECT_ID")"
      export PROXY_CLIENT_CADDY_OUTLINE_APP_HOSTNAME="$(bitwarden::get_secret 'app-outline-hostname' "$BWS_PROJECT_ID")"
      export PROXY_FRP_PORT="$(bitwarden::get_secret 'proxy-frp-port' "$BWS_PROJECT_ID")"
      export PROXY_FRP_TOKEN="$(bitwarden::get_secret 'proxy-frp-token' "$BWS_PROJECT_ID")"
@module proxy-client-setup.bash
      ;;
    authentik-setup.bash)
@module authentik-setup.bash
      # Post-install notice for Authentik
      print_authentik_next_steps
      ;;
    outline-setup.bash)
      export OUTLINE_APP_HOSTNAME="$PROXY_CLIENT_CADDY_OUTLINE_APP_HOSTNAME"
      export OUTLINE_AUTHENTIK_CLIENT_ID="$(bitwarden::get_secret 'app-outline-authentik-client-id' "$BWS_PROJECT_ID")"
      export OUTLINE_AUTHENTIK_CLIENT_SECRET="$(bitwarden::get_secret 'app-outline-authentik-client-secret' "$BWS_PROJECT_ID")"
      export OUTLINE_AUTHENTIK_URL="$(bitwarden::get_secret 'app-outline-authentik-url' "$BWS_PROJECT_ID")"

@module outline-setup.bash
      ;;
    *)
      logger::warn "Unknown module '$module_app' — skipped"
      continue
      ;;
  esac

  logger::ok "$module_app: Done"
done

echo
echo "Server successfully configured"
